// استدعاء ملف firebase.js اللي عملناه
import firebaseApp from '../../firebase';
import { getDatabase, ref, query, orderByChild, equalTo, get } from "firebase/database";

export default async function handler(req, res) {
  if (req.method === 'POST') {
    const { code } = req.body; // الكود اللي بيجي من العميل

    try {
      const db = getDatabase(firebaseApp); // قاعدة البيانات
      const storiesRef = ref(db, 'stories'); // الإشارة لجدول القصص
      const q = query(storiesRef, orderByChild('code'), equalTo(code));
      const snapshot = await get(q);

      if (!snapshot.exists()) {
        return res.status(404).json({ message: 'لم يتم العثور على قصة لهذا الكود' });
      }

      const data = snapshot.val();
      const storyData = Object.values(data)[0]; // أول نتيجة
      const { title, story, imageUrl, videoUrl } = storyData;

      return res.status(200).json({
        title: title || 'قصة غير معروفة',
        story: story || 'لا توجد تفاصيل متوفرة.',
        imageUrl: imageUrl || null,
        videoUrl: videoUrl || null,
      });
    } catch (error) {
      console.error('خطأ:', error);
      return res.status(500).json({ message: 'حدث خطأ في الخادم' });
    }
  } else {
    res.setHeader('Allow', ['POST']);
    res.status(405).end(`الطريقة ${req.method} غير مسموح بها`);
  }
}
